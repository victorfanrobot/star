<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´«å¾®æ–—æ•¸ AI å¤§å¸«ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.4/lunar.js"></script>
    <style>
        :root {
            --border: #5d4037; --bg: #fffbf0;
            --main-red: #d32f2f; --main-blue: #1976d2;
            --si-hua: #2e7d32; --assistant: #7b1fa2;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f1ea; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        /* è¼¸å…¥é¢æ¿ */
        .input-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 700px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; border-top: 5px solid var(--border); }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; outline: none; }
        button.primary-btn { background: var(--border); color: white; border: none; cursor: pointer; transition: 0.3s; }
        button.primary-btn:hover { background: #3e2723; }
        button.ai-btn { background: #2e7d32; color: white; border: none; cursor: pointer; width: 100%; font-size: 1.1em; margin-top: 10px; border-radius: 8px; }

        /* å‘½ç›¤ä¸»é«” */
        .chart {
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
            width: 95vw; height: 95vw; max-width: 700px; max-height: 700px;
            background: var(--bg); border: 3px solid var(--border);
        }
        .cell { border: 0.5px solid #d2b48c; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .center { grid-column: 2 / 4; grid-row: 2 / 4; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px inset var(--border); text-align: center; font-size: 0.9em; padding: 10px; }

        /* æ˜Ÿæ›œé¡¯ç¤º */
        .stars-box { display: flex; flex-direction: row-reverse; height: 85%; flex-wrap: wrap-reverse; align-content: flex-start; }
        .star { writing-mode: vertical-rl; font-weight: bold; font-size: 15px; margin-left: 3px; position: relative; line-height: 1.2; }
        .zi-red { color: var(--main-red); }
        .fu-blue { color: var(--main-blue); }
        .ast-purple { color: var(--assistant); font-size: 13px; }
        
        .sihua { font-size: 10px; background: var(--si-hua); color: white; border-radius: 3px; padding: 1px 2px; writing-mode: horizontal-tb; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); }

        .palace-label { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; border-top: 1px solid #eee; padding-top: 2px; }
        .active-palace { background: #fffde7; }

        /* AI çµæœå€ */
        #ai-section { width: 100%; max-width: 700px; margin-top: 20px; }
        #ai-result { background: white; padding: 20px; border-radius: 10px; margin-top: 10px; border-left: 8px solid #2e7d32; line-height: 1.8; min-height: 100px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        @media (max-width: 500px) {
            .star { font-size: 12px; margin-left: 1px; }
            .input-panel { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="input-panel">
    <div>
        <strong>å§“å:</strong> <input type="text" id="name" style="width: 80px" value="è¨ªå®¢">
        <strong>API Key:</strong> <input type="password" id="apiKey" placeholder="åœ¨æ­¤è¼¸å…¥ Gemini API Key" style="width: 150px">
    </div>
    <div>
        <strong>ç”Ÿæ—¥:</strong> <input type="date" id="bDay" value="1990-01-01">
        <strong>æ™‚è¾°:</strong>
        <select id="bTime">
            <option value="0">å­(23-01)</option><option value="1">ä¸‘(01-03)</option>
            <option value="2">å¯…(03-05)</option><option value="3">å¯(05-07)</option>
            <option value="4">è¾°(07-09)</option><option value="5">å·³(09-11)</option>
            <option value="6">åˆ(11-13)</option><option value="7">æœª(13-15)</option>
            <option value="8">ç”³(15-17)</option><option value="9">é…‰(17-19)</option>
            <option value="10">æˆŒ(19-21)</option><option value="11">äº¥(21-23)</option>
        </select>
        <button class="primary-btn" onclick="mainAction()">å³åˆ»æ’ç›¤</button>
    </div>
</div>

<div class="chart" id="chart">
    <div class="cell" id="c5" style="grid-area:1/1"></div><div class="cell" id="c6" style="grid-area:1/2"></div>
    <div class="cell" id="c7" style="grid-area:1/3"></div><div class="cell" id="c8" style="grid-area:1/4"></div>
    <div class="cell" id="c4" style="grid-area:2/1"></div><div class="cell" id="c9" style="grid-area:2/4"></div>
    <div class="cell" id="c3" style="grid-area:3/1"></div><div class="cell" id="c10" style="grid-area:3/4"></div>
    <div class="cell" id="c2" style="grid-area:4/1"></div><div class="cell" id="c1" style="grid-area:4/2"></div>
    <div class="cell" id="c0" style="grid-area:4/3"></div><div class="cell" id="c11" style="grid-area:4/4"></div>
    <div class="center" id="mid">è«‹è¼¸å…¥è³‡æ–™</div>
</div>

<div id="ai-section">
    <button class="ai-btn" onclick="getAIDivination()">ğŸ”® å¬å–š AI å¤§å¸«æ·±åº¦è§£ç›¤</button>
    <div id="ai-result">æ’ç›¤å¾Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼ŒAI å°‡ç‚ºæ‚¨è§£æå‘½æ ¼...</div>
</div>

<script>
const DZ = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const PLS = ["å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„","é·ç§»","å¥´åƒ•","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"];
const SIHUA_TABLE = {
    'ç”²':['å»‰è²','ç ´è»','æ­¦æ›²','å¤ªé™½'], 'ä¹™':['å¤©æ©Ÿ','å¤©æ¢','ç´«å¾®','å¤ªé™°'],
    'ä¸™':['å¤©åŒ','å¤©æ©Ÿ','æ–‡æ˜Œ','å»‰è²'], 'ä¸':['å¤ªé™°','å¤©åŒ','å¤©æ©Ÿ','å·¨é–€'],
    'æˆŠ':['è²ªç‹¼','å¤ªé™°','å³å¼¼','å¤©æ©Ÿ'], 'å·±':['æ­¦æ›²','è²ªç‹¼','å¤©æ¢','æ–‡æ›²'],
    'åºš':['å¤ªé™½','æ­¦æ›²','å¤©åºœ','å¤©åŒ'], 'è¾›':['å·¨é–€','å¤ªé™½','æ–‡æ›²','æ–‡æ˜Œ'],
    'å£¬':['å¤©æ¢','ç´«å¾®','å·¦è¼”','æ­¦æ›²'], 'ç™¸':['ç ´è»','å·¨é–€','å¤ªé™°','è²ªç‹¼']
};

function mainAction() {
    const solar = Solar.fromDate(new Date(document.getElementById('bDay').value));
    const lunar = solar.getLunar();
    const m = lunar.getMonth(), d = lunar.getDay(), t = parseInt(document.getElementById('bTime').value);
    const gan = lunar.getYearGan();

    let lifeIdx = (2 + (m - 1) - t + 12) % 12;
    
    for(let i=0; i<12; i++) {
        document.getElementById('c'+i).innerHTML = '<div class="stars-box"></div><div class="palace-label"></div>';
        document.getElementById('c'+i).className = 'cell';
    }

    for(let i=0; i<12; i++){
        let p = (lifeIdx + i) % 12;
        document.getElementById('c'+p).querySelector('.palace-label').innerHTML = `<span>${PLS[i]}</span><span>${DZ[p]}</span>`;
        if(i===0) document.getElementById('c'+p).classList.add('active-palace');
    }

    // ç°¡åŒ–ç´«å¾®å®šä½é‚è¼¯
    let zv = (2 + (Math.ceil(d/3)) + (d % 3)) % 12; 
    const sh = SIHUA_TABLE[gan];

    const zvS = ["ç´«å¾®","å¤©æ©Ÿ","","å¤ªé™½","æ­¦æ›²","å¤©åŒ","","","å»‰è²"];
    zvS.forEach((s, i) => { if(s) addStar((zv-i+12)%12, s, 'zi-red', sh); });
    let tf = (4 - zv + 12) % 12;
    const tfS = ["å¤©åºœ","å¤ªé™°","è²ªç‹¼","å·¨é–€","å¤©ç›¸","å¤©æ¢","ä¸ƒæ®º","","","","","ç ´è»"];
    tfS.forEach((s, i) => { if(s) addStar((tf+i)%12, s, 'fu-blue', sh); });

    // è¼”æ˜Ÿ
    addStar((10 - t + 12)%12, "æ–‡æ˜Œ", "ast-purple", sh);
    addStar((2 + t)%12, "æ–‡æ›²", "ast-purple", sh);

    document.getElementById('mid').innerHTML = `<strong>${document.getElementById('name').value}</strong><br>${lunar.getYearInChinese()}å¹´<br>${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}æ—¥<br>${gan}å¹´å››åŒ–ï¼š${sh.join('')}`;
}

function addStar(p, name, cl, sh) {
    const box = document.getElementById('c'+p).querySelector('.stars-box');
    const span = document.createElement('div');
    span.className = 'star ' + cl;
    span.innerText = name;
    
    const type = ["ç¥¿","æ¬Š","ç§‘","å¿Œ"];
    const idx = sh.indexOf(name);
    if(idx !== -1) {
        const s = document.createElement('span');
        s.className = 'sihua';
        s.innerText = type[idx];
        span.appendChild(s);
    }
    box.appendChild(span);
}

async function getAIDivination() {
//    const key = document.getElementById('apiKey').value;
    const key = "AIzaSyDqjHTHTaztFlrRvlF-kpbzKOsT0e6rTgo"
    if(!key) { alert("è«‹å…ˆè¼¸å…¥ Gemini API Key"); return; }

    const info = document.getElementById('mid').innerText;
    const resultDiv = document.getElementById('ai-result');
    resultDiv.innerHTML = "<em>æ­£åœ¨èˆ‡ AI å¤§å¸«æºé€šä¸­ï¼Œè«‹ç¨å€™...</em>";

    const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šç´«å¾®æ–—æ•¸çš„å‘½ç†å°ˆå®¶ã€‚
    ç•¶å‰æ’ç›¤è³‡è¨Šï¼š${info}ã€‚
    è«‹æ ¹æ“šæ­¤å‘½ç›¤ï¼Œåˆ†æä½¿ç”¨è€…çš„æ€§æ ¼å„ªé»ã€æ½›åœ¨æŒ‘æˆ°ï¼Œä¸¦çµ¦äºˆä¸€å€‹å…·é«”çš„ç•¶å¹´é–‹é‹å»ºè­°ã€‚è«‹ç”¨å°ˆæ¥­ã€é¼“å‹µä¸”å¯Œæœ‰å“²ç†çš„èªæ°£å›ç­”ï¼Œä¸è¶…é 300 å­—ã€‚`;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await resp.json();
        resultDiv.innerText = data.candidates[0].content.parts[0].text;
    } catch (e) {
        resultDiv.innerText = "é€£ç·šç•°å¸¸ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºæˆ–ç¶²è·¯æ˜¯å¦é€šæš¢ã€‚";
    }
}
</script>
</body>
</html>