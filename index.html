<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>專業紫微斗數排盤系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.4/lunar.js"></script>
    <style>
        :root {
            --wood: #2e7d32; --fire: #c62828; --earth: #ef6c00; --metal: #f9a825; --water: #1565c0;
            --border: #8b4513; --bg: #fffcf5;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* 輸入區美化 */
        .input-box { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input, select, button { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: var(--fire); color: white; border: none; cursor: pointer; font-weight: bold; }

        /* 命盤主體 */
        .chart {
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
            width: 650px; height: 650px; background: var(--bg); border: 3px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .cell {
            border: 0.5px solid #d2b48c; padding: 8px; display: flex; flex-direction: column;
            justify-content: space-between; position: relative; overflow: hidden;
        }
        .center { 
            grid-column: 2 / 4; grid-row: 2 / 4; background: white; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 2px inset var(--border); text-align: center; line-height: 1.6;
        }

        /* 星曜樣式 */
        .stars-container { display: flex; flex-direction: row-reverse; height: 70%; flex-wrap: wrap-reverse; }
        .star { writing-mode: vertical-rl; font-weight: bold; font-size: 1.1em; margin-left: 4px; }
        .ziwei-star { color: var(--fire); } /* 紫微系 */
        .tianfu-star { color: var(--water); } /* 天府系 */
        
        .palace-info { display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #eee; padding-top: 5px; }
        .palace-name { font-weight: bold; color: var(--border); font-size: 1.1em; }
        .dz-name { color: #999; font-size: 0.8em; }
        .active-palace { background: #fff9c4; } /* 命宮底色 */
    </style>
</head>
<body>

<div class="input-box">
    <strong>姓名:</strong> <input type="text" id="name" value="訪客" style="width:70px">
    <strong>西元生日:</strong> <input type="date" id="bDay" value="1990-05-15">
    <strong>時辰:</strong>
    <select id="bTime">
        <option value="0">子 (23-01)</option><option value="1">丑 (01-03)</option>
        <option value="2">寅 (03-05)</option><option value="3">卯 (05-07)</option>
        <option value="4">辰 (07-09)</option><option value="5">巳 (09-11)</option>
        <option value="6">午 (11-13)</option><option value="7">未 (13-15)</option>
        <option value="8">申 (15-17)</option><option value="9">酉 (17-19)</option>
        <option value="10">戌 (19-21)</option><option value="11">亥 (21-23)</option>
    </select>
    <button onclick="main()">開始排盤</button>
</div>

<div class="chart" id="chart">
    <div class="cell" id="c5" style="grid-area:1/1"></div><div class="cell" id="c6" style="grid-area:1/2"></div>
    <div class="cell" id="c7" style="grid-area:1/3"></div><div class="cell" id="c8" style="grid-area:1/4"></div>
    <div class="cell" id="c4" style="grid-area:2/1"></div><div class="cell" id="c9" style="grid-area:2/4"></div>
    <div class="cell" id="c3" style="grid-area:3/1"></div><div class="cell" id="c10" style="grid-area:3/4"></div>
    <div class="cell" id="c2" style="grid-area:4/1"></div><div class="cell" id="c1" style="grid-area:4/2"></div>
    <div class="cell" id="c0" style="grid-area:4/3"></div><div class="cell" id="c11" style="grid-area:4/4"></div>
    <div class="center" id="mid">請點擊排盤</div>
</div>

<script>
const dz = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
const palaces = ["命宮","兄弟","夫妻","子女","財帛","疾厄","遷移","奴僕","官祿","田宅","福德","父母"];

function main() {
    const solar = Solar.fromDate(new Date(document.getElementById('bDay').value));
    const lunar = solar.getLunar();
    const m = lunar.getMonth();
    const d = lunar.getDay();
    const t = parseInt(document.getElementById('bTime').value);
    
    // 1. 定命宮位置 (寅宮起正月順數月，逆數時)
    let lifeIdx = (2 + (m - 1) - t + 12) % 12;

    // 2. 定五行局 (簡化版：根據命宮地支與年干決定)
    // 實際需要 60 納音表，這裡先以公式模擬
    const juNames = ["","","木三局","金四局","土五局","火六局","水二局"];
    let ju = 3; // 預設木三局

    // 3. 定紫微星位置 (公式：生日/局數...餘數)
    let quotient = Math.ceil(d / ju);
    let remainder = d % ju;
    let offset = remainder === 0 ? 0 : (ju - remainder);
    let zvPos = (2 + (quotient + offset) + (offset % 2 === 0 ? -offset : offset)) % 12;

    renderChart(lifeIdx, zvPos, lunar);
}

function renderChart(lifeIdx, zvPos, lunar) {
    // 清空舊內容
    for(let i=0; i<12; i++) {
        document.getElementById('c'+i).innerHTML = '<div class="stars-container"></div><div class="palace-info"></div>';
        document.getElementById('c'+i).classList.remove('active-palace');
    }

    // 排十二宮
    for(let i=0; i<12; i++) {
        let pos = (lifeIdx + i) % 12;
        let cell = document.getElementById('c'+pos);
        cell.querySelector('.palace-info').innerHTML = `<span class="palace-name">${palaces[i]}</span><span class="dz-name">${dz[pos]}</span>`;
        if(i===0) cell.classList.add('active-palace');
    }

    // 排紫微星系 (逆行)
    const zvStars = ["紫微","天機","","太陽","武曲","天同","","","廉貞"];
    zvStars.forEach((s, i) => {
        if(s) addStar( (zvPos - i + 12) % 12, s, 'ziwei-star' );
    });

    // 排天府星系 (順行，對稱軸在寅申)
    let tfPos = (4 - zvPos + 12) % 12;
    const tfStars = ["天府","太陰","貪狼","巨門","天相","天梁","七殺","","","","","破軍"];
    tfStars.forEach((s, i) => {
        if(s) addStar( (tfPos + i) % 12, s, 'tianfu-star' );
    });

    // 中宮資訊
    document.getElementById('mid').innerHTML = `
        <h2 style="color:var(--fire)">${document.getElementById('name').value}</h2>
        <p>農曆：${lunar.getMonthInChinese()}月${lunar.getDayInChinese()}日</p>
        <p>八字：${lunar.getEightChar().getYear()} ${lunar.getEightChar().getMonth()} ${lunar.getEightChar().getDay()}</p>
        <p>五行：木三局 (範例)</p>
    `;
}

function addStar(pos, name, className) {
    const container = document.getElementById('c'+pos).querySelector('.stars-container');
    const span = document.createElement('span');
    span.className = 'star ' + className;
    span.innerText = name;
    container.appendChild(span);
}
</script>

</body>
</html>